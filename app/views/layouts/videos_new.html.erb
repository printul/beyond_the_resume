<!DOCTYPE html>
<html>
<head>
  <title>Be:yond</title>
    <%= csrf_meta_tags %>
    <%= action_cable_meta_tag %>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <%= stylesheet_link_tag    'application', media: 'all' %>
    <link rel="stylesheet" href="//assets-cdn.ziggeo.com/v1-stable/ziggeo.css" />
    <script src="//assets-cdn.ziggeo.com/v1-r26/ziggeo.js"></script>
    <script>ZiggeoApi.token = "r17f8d61d50e0795659099b07b0fab0e";
    ZiggeoApi.Config.webrtc = true;</script>
    <script>
    ZiggeoApi.Events.on("system_ready", function() {
            var element = document.getElementById('ziggeo');
            var recorder = ZiggeoApi.V2.Recorder.findByElement(element);
            var ziggeo_div = document.getElementById('ziggeo_div');
            var custom_upload_visual = document.getElementById('custom-upload-visual');
            var upload_percentage = document.getElementById('upload-percentage');
            var uploaded_msg = document.getElementById('upload-msg');
            var custom_uploaded_visual = document.getElementById('custom-uploaded-visual');

            recorder.on("uploading", function () {
              //Your code goes here
              console.log('uploading');
              ziggeo_div.hidden = true;
              custom_upload_visual.hidden = false;
              upload_percentage.innerHTML = "Uploading..."
            });

            recorder.on("recording", function () {
              //Your code goes here
              console.log('RECORDING IN PROGRESS');
            });

            recorder.on("verified", function () {
              //Your code goes here
              console.log("VERIFIED SUCCESS");
              uploaded_msg.hidden = true;
              custom_uploaded_visual.hidden = true;
              ziggeo_div.hidden = false;
            });

            recorder.on("upload_progress", function ( uploaded, total ) {
              //Your code goes here
              console.log('upload progress:' + (uploaded/total) * 100);
              var timer = setInterval(upload_percent, 1000);
              function upload_percent() {
                upload_percentage.innerHTML = "Uploading " + Math.round(((uploaded/total) * 100)) + "%";

                if (uploaded === total) {
                  clearInterval(timer);
                  upload_percentage.innerHTML = "Uploading Done. Verifying."
                  custom_upload_visual.hidden = true;
                }
              };
            });

            recorder.on("uploaded", function () {
              custom_upload_visual.hidden = true;
              ziggeo_div.hidden = false;
            });

            recorder.on("playing", function () {
              console.log('playing');
              document.getElementById('box-guest-signup').hidden = false;
            });

            recorder.on("processed", function () {
            });
        });
    </script>
</head>
<body>
    <%= render 'shared/navbar' %>
    <%= render 'shared/flashes' %>
    <% if user_signed_in?  %>
      <% unless current_user.is_business? %>
        <%= render 'shared/page_title_bar' %>
        <div class="sidebar">
          <%= render 'shared/sidebar' %>
        </div>
      <% end %>
    <% end %>
      <div class="fixed-navbar">
        <div class="container">
          <div class="box box-full-height" style="min-height: 485px;">
            <div class="text-center" id="ziggeo_div">
              <ziggeorecorder
              id='ziggeo'
              ziggeo-width=640
              ziggeo-height=480
              ziggeo-tags='<%= @guest_user.id %>'
              >
              </ziggeorecorder>
            </div>
            <div id="custom-upload-visual" hidden=true style="height: 485px;">
              <h1 id="upload-percentage"></h1>
            </div>
            <div id="custom-uploaded-visual" hidden=true style="height: 485px;"">
              <h1 id="uploaded-msg">Uploaded. Verifying...</h1>
            </div>
            <%= link_to 'Sign up and save', new_user_registration_path, id: 'box-guest-signup', hidden: true %>
          </div>
        </div>
      </div>
      <%= render 'shared/footer' %>
      <%= javascript_include_tag 'application' %>
</body>
</html>
