<!DOCTYPE html>
<html>
<head>
  <title>Be:yond</title>
    <%= csrf_meta_tags %>
    <%= action_cable_meta_tag %>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <%= stylesheet_link_tag    'application', media: 'all' %>
    <link rel="stylesheet" href="//assets-cdn.ziggeo.com/v1-r26/ziggeo.css" />

    <script src="//assets-cdn.ziggeo.com/v1-r26/ziggeo.js"></script>
      <script>ZiggeoApi.token = "r17f8d61d50e0795659099b07b0fab0e";
    ZiggeoApi.Config.webrtc = true;</script>
     <script>
    ZiggeoApi.Events.on("system_ready", function() {
            var element = document.getElementById('ziggeo');
            var recorder = ZiggeoApi.V2.Recorder.findByElement(element);
            var ziggeo_div = document.getElementById('ziggeo_div');
            var messages_div = document.getElementById('messages-div');
            var video_messages = document.getElementById('video-messages');
            var upload_done = false;
            var processing_done = false;

            var record_btn = document.getElementById('btn-record');
            var upload_btn = document.getElementById('btn-upload');
            record_btn.addEventListener("click", startRecord);
            upload_btn.addEventListener("click", startUpload);
            function startRecord() {
              ziggeo_div.hidden = false;
              recorder.record();
              record_btn.hidden = true;
              upload_btn.hidden = true;
            };

            function startUpload() {
              var a = document.getElementsByClassName('ba-videorecorder-theme-elevate-chooser-file');
              a[0].click();
              ziggeo_div.hidden = false;
              record_btn.hidden = true;
              upload_btn.hidden = true;
            };

            recorder.on("attached", function () {
    console.log('attached');
});
            recorder.on("uploading", function () {
              // hides ziggeo recorder and displays custom messages
              console.log('uploading');
              ziggeo_div.hidden = true;
              video_messages.innerHTML = "Uploading...";
              messages_div.hidden = false;
            });

            recorder.on("upload_progress", function ( uploaded, total ) {
              //displays upload %
                if (upload_done == false) {
                  video_messages.innerHTML = "Uploading " + Math.round(((uploaded/total) * 100)) + "%";
                }

                if (uploaded === total && upload_done != true) {
                  upload_done = true;

                }
            });

            recorder.on("uploaded", function () {
              // completed upload
              video_messages.innerHTML = "Upload Successful. Processing..."
            });

            recorder.on("verified", function () {
              // video verfified to allow processing
              console.log('verified');
              // video_messages.innerHTML = "Video Processing..."
              video_messages.innerHTML = "Video Processed."
              function showZiggeo() {
                messages_div.hidden = true;
                ziggeo_div.hidden = false;
              };
              //displays ziggeo after 3 seconds after processing
              setTimeout(showZiggeo,3000);
            });

            /* NOT WORKING UNTIL ZIGGEO UPDATES
            recorder.on("processing", function ( percentage ) {
              console.log(percentage);
            });

            recorder.on("processed", function () {
              // displays processing completed
              console.log('processed');
              video_messages.innerHTML = "Video Processed."
              function showZiggeo() {
                video_messages.hidden = true;
                ziggeo_div.hidden = false;
              };
              //displays ziggeo after 3 seconds after processing
              setTimeout(showZiggeo,3000);
            });
            */

            recorder.on("playing", function () {
              // displays sign up and save button after playing video
              document.getElementById('box-guest-signup').hidden = false;
            });
        });

    </script>

</head>
<body>
    <%= render 'shared/navbar' %>
    <%= render 'shared/flashes' %>
    <% if user_signed_in?  %>
      <% unless current_user.is_business? %>
        <%= render 'shared/page_title_bar' %>
        <div class="sidebar">
          <%= render 'shared/sidebar' %>
        </div>
      <% end %>
    <% end %>
      <div class="fixed-navbar">
        <div class="container">
          <div class="box box-full-height" style="min-height: 485px;">
            <div class="text-center" id="ziggeo_div" hidden=true>
              <ziggeorecorder
              id='ziggeo'
              ziggeo-width=640
              ziggeo-height=480
              ziggeo-tags='<%= @guest_user.id %>'
              ziggeo-theme='elevate'
              ziggeo-allowrecord=false
              >
              </ziggeorecorder>
            </div>
            <div id="messages-div" hidden=true style="height: 485px;">
              <h1 class="text-center" id="video-messages"></h1>
            </div>
            <%= link_to 'Sign up and save', new_user_registration_path, id: 'box-guest-signup', hidden: true %>
            <button id="btn-record">Record</button>
            <button id="btn-upload">Upload</button>
          </div>
      </div>
    </div>
      <%= render 'shared/footer' %>
      <%= javascript_include_tag 'application' %>

</body>
</html>
